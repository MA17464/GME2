{% extends 'base.html' %}

{% block title %}Application Details - GME Portal{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="mb-6">
        <a href="{% if user.is_applicant %}{% url 'core:dashboard' %}{% elif program_id %}{% url 'applications:program_applications' program_id %}{% else %}{% url 'applications:list' %}{% endif %}" class="flex items-center text-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
            </svg>
            Back to Applications
        </a>
    </div>

    <div class="card">
        <!-- Application Header -->
        <div class="bg-primary text-white p-6">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-2xl font-bold mb-1">Application for {{ application.program.name }}</h1>
                    <p class="text-white opacity-90">{{ application.program.get_department_display }} - {{ application.program.get_program_type_display }}</p>
                </div>
                <div>
                    <span class="status-badge status-{{ application.status }}">
                        {{ application.get_status_display }}
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Application Details -->
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Left Column - Applicant Info -->
                <div class="md:col-span-2">
                    <div class="mb-8">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Applicant Information</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">Full Name</h3>
                                <p class="text-gray-900">{{ application.applicant.get_full_name }}</p>
                            </div>
                            
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">Username</h3>
                                <p class="text-gray-900">{{ application.applicant.username }}</p>
                            </div>
                            
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">Email</h3>
                                <p class="text-gray-900">{{ application.applicant.email }}</p>
                            </div>
                            
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">Phone</h3>
                                <p class="text-gray-900">{{ application.applicant.phone|default:"Not provided" }}</p>
                            </div>
                            
                            {% if application.applicant.arabic_first_name or application.applicant.arabic_last_name %}
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500">Arabic Name</h3>
                                    <p class="text-gray-900">{{ application.applicant.arabic_first_name }} {{ application.applicant.arabic_last_name }}</p>
                                </div>
                            {% endif %}
                            
                            {% if application.applicant.national_id %}
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500">National ID</h3>
                                    <p class="text-gray-900">{{ application.applicant.national_id }}</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Application Details</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-6">
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">Applied On</h3>
                                <p class="text-gray-900">{{ application.created_at|date:"F j, Y" }}</p>
                            </div>
                            
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">Last Updated</h3>
                                <p class="text-gray-900">{{ application.updated_at|date:"F j, Y" }}</p>
                            </div>
                            
                            {% if application.status_updated_at %}
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500">Status Last Changed</h3>
                                    <p class="text-gray-900">{{ application.status_updated_at|date:"F j, Y" }}</p>
                                </div>
                            {% endif %}
                            
                            {% if application.status_updated_by %}
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500">Status Changed By</h3>
                                    <p class="text-gray-900">{{ application.status_updated_by.get_full_name }}</p>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-6">
                            <h3 class="text-sm font-medium text-gray-500 mb-2">Personal Statement</h3>
                            <div class="bg-gray-50 p-4 rounded-lg text-gray-800">
                                {% if application.personal_statement %}
                                    <p>{{ application.personal_statement|linebreaks }}</p>
                                {% else %}
                                    <p class="text-gray-500 italic">No personal statement provided.</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-sm font-medium text-gray-500 mb-2">Additional Information</h3>
                            <div class="bg-gray-50 p-4 rounded-lg text-gray-800">
                                {% if application.additional_info %}
                                    <p>{{ application.additional_info|linebreaks }}</p>
                                {% else %}
                                    <p class="text-gray-500 italic">No additional information provided.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    {% if application.documents.all %}
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Documents</h2>
                            
                            <div class="bg-gray-50 rounded-lg p-4">
                                <ul class="document-list">
                                    {% for document in application.documents.all %}
                                        <li class="document-item">
                                            <div class="document-info">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="document-icon h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                                </svg>
                                                <div>
                                                    <p class="document-name">{{ document.get_document_type_display }}</p>
                                                    <p class="document-meta">Uploaded on {{ document.uploaded_at|date:"M d, Y" }}</p>
                                                </div>
                                            </div>
                                            <a href="{{ document.file.url }}" target="_blank" class="document-action">
                                                View
                                            </a>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Right Column - Status & Actions -->
                <div>
                    <div class="card mb-6">
                        <div class="card-header">
                            <h2 class="text-lg font-semibold text-gray-800">Application Status</h2>
                        </div>
                        <div class="card-body">
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-600">Current Status:</span>
                                    <span class="status-badge status-{{ application.status }}">
                                        {{ application.get_status_display }}
                                    </span>
                                </div>
                                
                                <div class="relative pt-1">
                                    <div class="flex mb-2 items-center justify-between">
                                        <div>
                                            <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full bg-{{ application.status }}-100 text-{{ application.status }}-800">
                                                Progress
                                            </span>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-xs font-semibold inline-block text-gray-600">
                                                {% if application.status == 'submitted' %}25%
                                                {% elif application.status == 'eligible' %}75%
                                                {% elif application.status == 'approved' or application.status == 'rejected' %}100%{% endif %}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="progress">
                                        {% if application.status == 'submitted' %}
                                            <div class="progress-bar progress-bar-warning" style="width: 25%"></div>
                                        {% elif application.status == 'eligible' %}
                                            <div class="progress-bar progress-bar-info" style="width: 75%"></div>
                                        {% elif application.status == 'approved' %}
                                            <div class="progress-bar progress-bar-success" style="width: 100%"></div>
                                        {% elif application.status == 'rejected' %}
                                            <div class="progress-bar progress-bar-danger" style="width: 100%"></div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="step-indicator border-t pt-4">
                                    <div class="step {% if application.status != 'submitted' %}completed{% endif %}">
                                        <div class="step-number">1</div>
                                        <div class="step-label">
                                            <p>Application Submitted</p>
                                            <p class="text-xs text-gray-500">{{ application.created_at|date:"M d, Y" }}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="step {% if application.status == 'eligible' or application.status == 'approved' or application.status == 'rejected' %}completed{% elif application.status != 'submitted' %}active{% endif %}">
                                        <div class="step-number">2</div>
                                        <div class="step-label">
                                            <p>Program Director Review</p>
                                            <p class="text-xs text-gray-500">
                                                {% if application.status == 'submitted' %}Pending
                                                {% elif application.status == 'eligible' or application.status == 'approved' or application.status == 'rejected' %}
                                                    {% if application.status_updated_at %}{{ application.status_updated_at|date:"M d, Y" }}{% else %}Completed{% endif %}
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div class="step {% if application.status == 'approved' %}completed active{% elif application.status == 'rejected' %}completed active{% endif %}">
                                        <div class="step-number">3</div>
                                        <div class="step-label">
                                            <p>Final Decision</p>
                                            <p class="text-xs text-gray-500">
                                                {% if application.status == 'submitted' or application.status == 'eligible' %}Pending
                                                {% elif application.status == 'approved' or application.status == 'rejected' %}
                                                    {% if application.status_updated_at %}{{ application.status_updated_at|date:"M d, Y" }}{% else %}Completed{% endif %}
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if user.is_program_director and user.department == application.program.department and application.status == 'pending' %}
                        <div class="card mb-6">
                            <div class="card-header">
                                <h3 class="text-lg font-semibold text-gray-800">Program Director Actions</h3>
                            </div>
                            <div class="card-body">
                                <p class="text-gray-600 mb-4">Review this application and mark it as eligible or reject it.</p>
                                <div class="flex space-x-2 mt-4">
                                    <a href="{% url 'applications:update_status' application.id %}?status=eligible" class="btn btn-primary flex-1">Mark Eligible</a>
                                    <a href="{% url 'applications:update_status' application.id %}?status=rejected" class="btn btn-danger flex-1">Reject</a>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if user.is_gme_staff and application.status == 'eligible' %}
                        <div class="card mb-6">
                            <div class="card-header">
                                <h3 class="text-lg font-semibold text-gray-800">GME Staff Actions</h3>
                            </div>
                            <div class="card-body">
                                <p class="text-gray-600 mb-4">Make a final decision on this eligible application.</p>
                                <div class="flex space-x-2 mt-4">
                                    <a href="{% url 'applications:update_status' application.id %}?status=approved" class="btn btn-success flex-1">Approve</a>
                                    <a href="{% url 'applications:update_status' application.id %}?status=rejected" class="btn btn-danger flex-1">Reject</a>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if user.is_applicant and application.applicant == user and application.status == 'submitted' %}
                        <div class="card">
                            <div class="card-header">
                                <h3 class="text-lg font-semibold text-gray-800">Application Actions</h3>
                            </div>
                            <div class="card-body">
                                <p class="text-gray-600 mb-4">You can edit your application while it's still pending.</p>
                                <a href="{% url 'applications:application_update' application.id %}" class="btn btn-primary w-full">Edit Application</a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            {% if application.notes.all %}
                <div class="mt-8 border-t pt-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Application Notes</h2>
                    
                    <div class="space-y-4">
                        {% for note in application.notes.all %}
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">{{ note.created_by.get_full_name }}</p>
                                        <p class="text-xs text-gray-500">{{ note.created_at|date:"F j, Y, g:i a" }}</p>
                                    </div>
                                    {% if note.created_by == user %}
                                        <a href="{% url 'applications:delete_note' note.id %}" class="text-danger text-sm" onclick="return confirmAction('Are you sure you want to delete this note?');">Delete</a>
                                    {% endif %}
                                </div>
                                <p class="text-gray-800">{{ note.content|linebreaks }}</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            
            {% if user.is_gme_staff or user.is_program_director or user.is_interviewer %}
                <div class="mt-8 border-t pt-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Add Note</h2>
                    
                    <form method="post" action="{% url 'applications:add_note' application.id %}" class="needs-validation">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="note-content" class="form-label">Note</label>
                            <textarea id="note-content" name="content" rows="3" class="form-textarea" placeholder="Add your notes about this application..."></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Add Note</button>
                        </div>
                    </form>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/applications.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize delete note confirmation
        const deleteLinks = document.querySelectorAll('a[onclick*="confirmAction"]');
        deleteLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const message = this.getAttribute('onclick').match(/'([^']+)'/)[1];
                confirmAction(message, () => {
                    window.location.href = this.getAttribute('href');
                });
            });
        });
        
        // Update status buttons
        const statusButtons = document.querySelectorAll('.btn-primary, .btn-success, .btn-danger');
        statusButtons.forEach(button => {
            if (button.getAttribute('href') && button.getAttribute('href').includes('update_status')) {
                button.classList.add('status-update-btn');
                
                // Extract status from URL query parameter
                const href = button.getAttribute('href');
                const url = new URL(href, window.location.origin);
                const status = url.searchParams.get('status');
                const applicationId = href.split('/')[3]; // Assuming URL format: /applications/update_status/123?status=...
                
                button.setAttribute('data-application-id', applicationId);
                button.setAttribute('data-status', status);
                
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const statusText = this.textContent.trim();
                    const confirmMessage = `Are you sure you want to ${statusText.toLowerCase()} this application?`;
                    
                    if (confirm(confirmMessage)) {
                        // Submit form via AJAX
                        const formData = new FormData();
                        formData.append('status', this.getAttribute('data-status'));
                        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                        
                        fetch(this.getAttribute('href'), {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('Application status updated successfully.');
                                window.location.reload();
                            } else {
                                alert('Error updating application status: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while updating the application status.');
                        });
                    }
                });
            }
        });
    });
</script>
{% endblock %} 